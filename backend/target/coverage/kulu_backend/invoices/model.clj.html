<html>
 <head>
  <link rel="stylesheet" href="../../coverage.css"/>  <title> kulu_backend/invoices/model.clj </title>
 </head>
 <body>
<span class="covered" title="1 out of 1 forms covered">
                 001&nbsp;&nbsp;(ns&nbsp;kulu-backend.invoices.model
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 002&nbsp;&nbsp;&nbsp;&nbsp;(:require&nbsp;[aws.sdk.s3&nbsp;:as&nbsp;s3]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 003&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[clj-http.client&nbsp;:as&nbsp;client]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 004&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[clojure.core.strint&nbsp;:refer&nbsp;:all]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 005&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[clojure.java.io&nbsp;:as&nbsp;io]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 006&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[clojure.string&nbsp;:as&nbsp;s]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 007&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[honeysql.core&nbsp;:as&nbsp;sql]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 008&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[honeysql.helpers&nbsp;:as&nbsp;h-sql]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 009&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[kulu-backend.config&nbsp;:as&nbsp;cfg]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 010&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[kulu-backend.db&nbsp;:as&nbsp;db&nbsp;:only&nbsp;[query&nbsp;insert!]]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 011&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[kulu-backend.invoice-categories.model&nbsp;:as&nbsp;inv-cat]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 012&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[kulu-backend.models.helpers.pagination&nbsp;:as&nbsp;pagination]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 013&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[kulu-backend.organizations.model&nbsp;:as&nbsp;org]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 014&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[kulu-backend.session-tokens.model&nbsp;:as&nbsp;token]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 015&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[kulu-backend.users.model&nbsp;:as&nbsp;user]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 016&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[schema.core&nbsp;:as&nbsp;schema]))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 017&nbsp;&nbsp;
                </span><br/>
<span class="partial" title="7 out of 8 forms covered">
                 018&nbsp;&nbsp;(defonce&nbsp;table-name&nbsp;:invoices)
                </span><br/>
<span class="partial" title="7 out of 8 forms covered">
                 019&nbsp;&nbsp;(defonce&nbsp;default-order&nbsp;"created_at")
                </span><br/>
<span class="partial" title="7 out of 8 forms covered">
                 020&nbsp;&nbsp;(defonce&nbsp;default-direction&nbsp;"desc")
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 021&nbsp;&nbsp;
                </span><br/>
<span class="partial" title="5 out of 16 forms covered">
                 022&nbsp;&nbsp;(assert&nbsp;(keyword?&nbsp;table-name)&nbsp;"the&nbsp;table-name&nbsp;must&nbsp;be&nbsp;a&nbsp;keyword")
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 023&nbsp;&nbsp;
                </span><br/>
<span class="partial" title="11 out of 12 forms covered">
                 024&nbsp;&nbsp;(defonce&nbsp;types&nbsp;&nbsp;{:company&nbsp;"Company"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 025&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:reimbursement&nbsp;"Reimbursement"})
                </span><br/>
<span class="partial" title="17 out of 18 forms covered">
                 026&nbsp;&nbsp;(defonce&nbsp;states&nbsp;{:submitted&nbsp;"Submitted"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 027&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:extracted&nbsp;"Extracted"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 028&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:reviewed&nbsp;"Reviewed"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 029&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:reimbursed&nbsp;"Reimbursed/Deducted"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 030&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:recorded&nbsp;"Recorded"})
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 031&nbsp;&nbsp;(schema/defschema&nbsp;ExpenseState
                </span><br/>
<span class="covered" title="9 out of 9 forms covered">
                 032&nbsp;&nbsp;&nbsp;&nbsp;(apply&nbsp;schema/enum&nbsp;(into&nbsp;[]&nbsp;(vals&nbsp;states))))
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 033&nbsp;&nbsp;(schema/defschema&nbsp;ExpenseType
                </span><br/>
<span class="covered" title="9 out of 9 forms covered">
                 034&nbsp;&nbsp;&nbsp;&nbsp;(apply&nbsp;schema/enum&nbsp;(into&nbsp;[]&nbsp;(vals&nbsp;types))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 035&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 036&nbsp;&nbsp;(defn&nbsp;assoc-presigned-url
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 037&nbsp;&nbsp;&nbsp;&nbsp;"Adds&nbsp;the&nbsp;S3&nbsp;presigned&nbsp;URL&nbsp;(key:&nbsp;attachment-url)&nbsp;and&nbsp;the&nbsp;attachment-content-type&nbsp;to&nbsp;the&nbsp;given&nbsp;invoice&nbsp;map.
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 038&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;generated&nbsp;URL&nbsp;defaults&nbsp;to&nbsp;24-hours&nbsp;expiry.
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 039&nbsp;&nbsp;&nbsp;&nbsp;Don't&nbsp;add&nbsp;a&nbsp;presigned&nbsp;url&nbsp;to&nbsp;an&nbsp;invoice&nbsp;without&nbsp;storage-key!"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 040&nbsp;&nbsp;&nbsp;&nbsp;[{:keys&nbsp;[storage-key]&nbsp;:as&nbsp;expense}]
                </span><br/>
<span class="covered" title="12 out of 12 forms covered">
                 041&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(or&nbsp;(nil?&nbsp;expense)&nbsp;(nil?&nbsp;storage-key))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 042&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expense
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 043&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;&nbsp;if&nbsp;we&nbsp;can&nbsp;add&nbsp;a&nbsp;presigned&nbsp;url,&nbsp;do&nbsp;so:
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 044&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[bucket&nbsp;(cfg/invoice-bucket)
                </span><br/>
<span class="covered" title="9 out of 9 forms covered">
                 045&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;presigned-url&nbsp;(s3/generate-presigned-url&nbsp;(cfg/aws-creds)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 046&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bucket&nbsp;storage-key&nbsp;{:http-method&nbsp;:get})
                </span><br/>
<span class="covered" title="9 out of 9 forms covered">
                 047&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;presigned-head-url&nbsp;(s3/generate-presigned-url&nbsp;(cfg/aws-creds)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 048&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bucket&nbsp;storage-key&nbsp;{:http-method&nbsp;:head})
                </span><br/>
<span class="partial" title="7 out of 8 forms covered">
                 049&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;content-type&nbsp;(->&nbsp;(client/head&nbsp;presigned-head-url)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 050&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:headers
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 051&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(get&nbsp;"Content-Type"))]
                </span><br/>
<span class="not-covered" title="0 out of 7 forms covered">
                 052&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(assoc&nbsp;expense&nbsp;:attachment-url&nbsp;presigned-url&nbsp;:attachment-content-type&nbsp;content-type))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 053&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 054&nbsp;&nbsp;(defn&nbsp;lookup
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 055&nbsp;&nbsp;&nbsp;&nbsp;"Finds&nbsp;an&nbsp;invoice&nbsp;by&nbsp;its&nbsp;UUID.
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 056&nbsp;&nbsp;&nbsp;&nbsp;It&nbsp;won't&nbsp;find&nbsp;soft-deleted&nbsp;invoices"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 057&nbsp;&nbsp;&nbsp;&nbsp;[id]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 058&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[uuid&nbsp;^java.util.UUID&nbsp;id]
                </span><br/>
<span class="covered" title="14 out of 14 forms covered">
                 059&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(->&nbsp;(h-sql/select&nbsp;:*)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 060&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(h-sql/from&nbsp;table-name)
                </span><br/>
<span class="covered" title="10 out of 10 forms covered">
                 061&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(h-sql/where&nbsp;[:=&nbsp;:id&nbsp;uuid]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 062&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[:=&nbsp;:deleted&nbsp;false])
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 063&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sql/format
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 064&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db/query
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 065&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;first
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 066&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assoc-presigned-url
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 067&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(dissoc&nbsp;:deleted))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 068&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 069&nbsp;&nbsp;(defn&nbsp;lookup-with-category
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 070&nbsp;&nbsp;&nbsp;&nbsp;[id]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 071&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[uuid&nbsp;^java.util.UUID&nbsp;id]
                </span><br/>
<span class="covered" title="17 out of 17 forms covered">
                 072&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(->&nbsp;(h-sql/select&nbsp;:*&nbsp;[:c.id&nbsp;"category-id"])
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 073&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(h-sql/from&nbsp;table-name)
                </span><br/>
<span class="covered" title="23 out of 23 forms covered">
                 074&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(h-sql/left-join&nbsp;[:users&nbsp;:u]&nbsp;[:=&nbsp;:invoices.email&nbsp;:u.email]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 075&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[:invoice_categories&nbsp;:ic]&nbsp;[:=&nbsp;:invoices.id&nbsp;:ic.invoice_id]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 076&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[:categories&nbsp;:c]&nbsp;[:=&nbsp;:c.id&nbsp;:ic.category_id])
                </span><br/>
<span class="covered" title="10 out of 10 forms covered">
                 077&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(h-sql/where&nbsp;[:=&nbsp;:invoices.id&nbsp;uuid]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 078&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[:=&nbsp;:invoices.deleted&nbsp;false])
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 079&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sql/format
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 080&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db/query
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 081&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;first
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 082&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assoc-presigned-url
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 083&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(dissoc&nbsp;:deleted))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 084&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 085&nbsp;&nbsp;(defn&nbsp;order-by
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 086&nbsp;&nbsp;&nbsp;&nbsp;[query&nbsp;order&nbsp;direction]
                </span><br/>
<span class="not-covered" title="0 out of 3 forms covered">
                 087&nbsp;&nbsp;&nbsp;&nbsp;(cond
                </span><br/>
<span class="not-covered" title="0 out of 21 forms covered">
                 088&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(=&nbsp;order&nbsp;"amount")&nbsp;(h-sql/order-by&nbsp;query&nbsp;[:currency&nbsp;(keyword&nbsp;direction)]&nbsp;[:amount&nbsp;(keyword&nbsp;direction)]&nbsp;[(keyword&nbsp;"invoices.id")])
                </span><br/>
<span class="not-covered" title="0 out of 16 forms covered">
                 089&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(=&nbsp;order&nbsp;"user_name")&nbsp;(h-sql/order-by&nbsp;query&nbsp;[:user-name&nbsp;(keyword&nbsp;direction)]&nbsp;[(keyword&nbsp;"invoices.id")])
                </span><br/>
<span class="not-covered" title="0 out of 17 forms covered">
                 090&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:else&nbsp;(h-sql/order-by&nbsp;query&nbsp;[(keyword&nbsp;(str&nbsp;"invoices."&nbsp;order))&nbsp;(keyword&nbsp;direction)]&nbsp;[(keyword&nbsp;"invoices.id")])))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 091&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 092&nbsp;&nbsp;;;&nbsp;TODO:
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 093&nbsp;&nbsp;;;&nbsp;left-join&nbsp;returns&nbsp;a&nbsp;flat-map&nbsp;which&nbsp;overrides&nbsp;similar&nbsp;column&nbsp;names
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 094&nbsp;&nbsp;(defn&nbsp;all
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 095&nbsp;&nbsp;&nbsp;&nbsp;"Returns&nbsp;a&nbsp;limited&nbsp;set&nbsp;of&nbsp;all&nbsp;invoices"
                </span><br/>
<span class="not-covered" title="0 out of 11 forms covered">
                 096&nbsp;&nbsp;&nbsp;&nbsp;([]&nbsp;(all&nbsp;{:page&nbsp;1&nbsp;:per-page&nbsp;10&nbsp;:direction&nbsp;:desc&nbsp;:order&nbsp;:created_at}))&nbsp;;;&nbsp;just&nbsp;some&nbsp;defaults
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 097&nbsp;&nbsp;&nbsp;&nbsp;([{:keys&nbsp;[organization-name&nbsp;page&nbsp;per-page&nbsp;order&nbsp;direction]&nbsp;:or&nbsp;{page&nbsp;1&nbsp;per-page&nbsp;10&nbsp;direction&nbsp;"desc"&nbsp;order&nbsp;"created_at"}}]
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 098&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;organization-name
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 099&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[org-id&nbsp;(:id&nbsp;(org/lookup-by-name&nbsp;organization-name))]
                </span><br/>
<span class="covered" title="11 out of 11 forms covered">
                 100&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(->&nbsp;(h-sql/select&nbsp;:*&nbsp;[:c.name&nbsp;"category-name"])
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 101&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(h-sql/from&nbsp;table-name)
                </span><br/>
<span class="covered" title="23 out of 23 forms covered">
                 102&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(h-sql/left-join&nbsp;[:users&nbsp;:u]&nbsp;[:=&nbsp;:invoices.email&nbsp;:u.email]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 103&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[:invoice_categories&nbsp;:ic]&nbsp;[:=&nbsp;:invoices.id&nbsp;:ic.invoice_id]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 104&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[:categories&nbsp;:c]&nbsp;[:=&nbsp;:c.id&nbsp;:ic.category_id])
                </span><br/>
<span class="covered" title="12 out of 12 forms covered">
                 105&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(h-sql/where&nbsp;[:and&nbsp;[:=&nbsp;:invoices.organization_id&nbsp;org-id]&nbsp;[:=&nbsp;:invoices.deleted&nbsp;false]])
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 106&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(order-by&nbsp;order&nbsp;direction)
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 107&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(pagination/paginate&nbsp;page&nbsp;per-page)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 108&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sql/format
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 109&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db/query
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 110&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(->>&nbsp;(map&nbsp;#(dissoc&nbsp;%&nbsp;:deleted))))))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 111&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 112&nbsp;&nbsp;(defn&nbsp;all-for-search
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 113&nbsp;&nbsp;&nbsp;&nbsp;[]
                </span><br/>
<span class="not-covered" title="0 out of 13 forms covered">
                 114&nbsp;&nbsp;&nbsp;&nbsp;(->&nbsp;(h-sql/select&nbsp;:*&nbsp;[:c.name&nbsp;"category-name"]&nbsp;[:u.user-name&nbsp;"user-name"])
                </span><br/>
<span class="not-covered" title="0 out of 3 forms covered">
                 115&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(h-sql/from&nbsp;table-name)
                </span><br/>
<span class="not-covered" title="0 out of 23 forms covered">
                 116&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(h-sql/left-join&nbsp;[:users&nbsp;:u]&nbsp;[:=&nbsp;:invoices.email&nbsp;:u.email]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 117&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[:invoice_categories&nbsp;:ic]&nbsp;[:=&nbsp;:invoices.id&nbsp;:ic.invoice_id]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 118&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[:categories&nbsp;:c]&nbsp;[:=&nbsp;:c.id&nbsp;:ic.category_id])
                </span><br/>
<span class="not-covered" title="0 out of 6 forms covered">
                 119&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(h-sql/where&nbsp;[:=&nbsp;:invoices.deleted&nbsp;false])
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 120&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sql/format
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 121&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db/query))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 122&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 123&nbsp;&nbsp;(defn&nbsp;store
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 124&nbsp;&nbsp;&nbsp;&nbsp;[m]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 125&nbsp;&nbsp;&nbsp;&nbsp;(->>&nbsp;m
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 126&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(db/insert!&nbsp;(keyword&nbsp;table-name))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 127&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;first))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 128&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 129&nbsp;&nbsp;(defn&nbsp;create
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 130&nbsp;&nbsp;&nbsp;&nbsp;"Creates&nbsp;an&nbsp;Invoice&nbsp;record
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 131&nbsp;&nbsp;&nbsp;&nbsp;When&nbsp;given&nbsp;a&nbsp;map&nbsp;without&nbsp;an&nbsp;:id&nbsp;<uuid>,&nbsp;a&nbsp;new&nbsp;:id&nbsp;is&nbsp;generated."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 132&nbsp;&nbsp;&nbsp;&nbsp;([]
                </span><br/>
<span class="not-covered" title="0 out of 3 forms covered">
                 133&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(create&nbsp;{}))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 134&nbsp;&nbsp;&nbsp;&nbsp;([m]
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 135&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[org-name&nbsp;(:organization-name&nbsp;m)
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 136&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;user-info&nbsp;(select-keys&nbsp;m&nbsp;[:email&nbsp;:user-name])
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 137&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;user&nbsp;(if&nbsp;(empty?&nbsp;(user-info&nbsp;:email))
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 138&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(->&nbsp;(str&nbsp;(:user-token&nbsp;m))
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 139&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(token/lookup-by-id)
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 140&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(:user-id)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(user/lookup-by-id))
                </span><br/>
<span class="not-covered" title="0 out of 3 forms covered">
                 142&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(user/create&nbsp;user-info))
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 143&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;invoice-params&nbsp;(->&nbsp;m
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 144&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(dissoc&nbsp;:user-name&nbsp;:user-token&nbsp;:organization-name)
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 145&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(assoc&nbsp;&nbsp;:email&nbsp;(:email&nbsp;user))
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 146&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(assoc&nbsp;&nbsp;:organization-id&nbsp;(:id&nbsp;(org/lookup-by-name&nbsp;org-name))))
                </span><br/>
<span class="covered" title="9 out of 9 forms covered">
                 147&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;invoice&nbsp;(store&nbsp;(merge
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 148&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{:id&nbsp;(or&nbsp;(m&nbsp;:id)&nbsp;(java.util.UUID/randomUUID))}
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 149&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{:status&nbsp;(:submitted&nbsp;states)}
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 150&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;invoice-params))]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 151&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;invoice)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 152&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 153&nbsp;&nbsp;(defn&nbsp;update
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 154&nbsp;&nbsp;&nbsp;&nbsp;[id&nbsp;attrs]
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 155&nbsp;&nbsp;&nbsp;&nbsp;(db/update!&nbsp;(keyword&nbsp;table-name)
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 156&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(dissoc&nbsp;attrs&nbsp;:category-id)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 157&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;["id&nbsp;=&nbsp;?"&nbsp;id])
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 158&nbsp;&nbsp;&nbsp;&nbsp;id)
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 159&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 160&nbsp;&nbsp;(defn&nbsp;update-with-category
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 161&nbsp;&nbsp;&nbsp;&nbsp;[id&nbsp;attrs]
                </span><br/>
<span class="covered" title="10 out of 10 forms covered">
                 162&nbsp;&nbsp;&nbsp;&nbsp;(db/exec-nested-transactions&nbsp;(flatten&nbsp;[#(update&nbsp;id&nbsp;attrs)
                </span><br/>
<span class="partial" title="8 out of 10 forms covered">
                 163&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(:category-id&nbsp;attrs)
                </span><br/>
<span class="not-covered" title="0 out of 6 forms covered">
                 164&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[#(inv-cat/upsert&nbsp;%&nbsp;(:category-id&nbsp;attrs))]
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 165&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[#(inv-cat/lookup-by-invoice-id&nbsp;%)
                </span><br/>
<span class="partial" title="4 out of 10 forms covered">
                 166&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[#(when&nbsp;(:id&nbsp;%)&nbsp;(inv-cat/delete&nbsp;(:id&nbsp;%)))]])]))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 167&nbsp;&nbsp;&nbsp;&nbsp;id)
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 168&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 169&nbsp;&nbsp;(defn&nbsp;delete!
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 170&nbsp;&nbsp;&nbsp;&nbsp;[id]
                </span><br/>
<span class="partial" title="5 out of 19 forms covered">
                 171&nbsp;&nbsp;&nbsp;&nbsp;(assert&nbsp;(lookup&nbsp;id)&nbsp;(format&nbsp;"the&nbsp;record&nbsp;%s&nbsp;you&nbsp;wanted&nbsp;to&nbsp;delete&nbsp;does&nbsp;not&nbsp;exist"&nbsp;id))
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 172&nbsp;&nbsp;&nbsp;&nbsp;(db/delete!&nbsp;table-name&nbsp;["id&nbsp;=&nbsp;?"&nbsp;id])
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 173&nbsp;&nbsp;&nbsp;&nbsp;id)
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 174&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 175&nbsp;&nbsp;(defn&nbsp;soft-delete
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 176&nbsp;&nbsp;&nbsp;&nbsp;"Marking&nbsp;a&nbsp;record&nbsp;as&nbsp;removed&nbsp;by&nbsp;setting&nbsp;its&nbsp;value&nbsp;'deleted'
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 177&nbsp;&nbsp;&nbsp;&nbsp;value&nbsp;to&nbsp;true.&nbsp;Returns&nbsp;true&nbsp;if&nbsp;removed.&nbsp;False&nbsp;if&nbsp;the&nbsp;uuid&nbsp;did&nbsp;not
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 178&nbsp;&nbsp;&nbsp;&nbsp;exist.&nbsp;Throws&nbsp;an&nbsp;AssertException&nbsp;if&nbsp;the&nbsp;item&nbsp;was&nbsp;not&nbsp;deleted&nbsp;correctly."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 179&nbsp;&nbsp;&nbsp;&nbsp;[id]
                </span><br/>
<span class="not-covered" title="0 out of 4 forms covered">
                 180&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[exists-before&nbsp;(lookup&nbsp;id)
                </span><br/>
<span class="not-covered" title="0 out of 9 forms covered">
                 181&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(db/update!&nbsp;table-name&nbsp;{:deleted&nbsp;true}&nbsp;["id&nbsp;=&nbsp;?"&nbsp;id])
                </span><br/>
<span class="not-covered" title="0 out of 3 forms covered">
                 182&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exists-after&nbsp;&nbsp;(lookup&nbsp;id)]
                </span><br/>
<span class="not-covered" title="0 out of 19 forms covered">
                 183&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(assert&nbsp;(nil?&nbsp;exists-after)&nbsp;(format&nbsp;"the&nbsp;item&nbsp;%s&nbsp;was&nbsp;not&nbsp;removed&nbsp;correctly!"&nbsp;id))
                </span><br/>
<span class="not-covered" title="0 out of 5 forms covered">
                 184&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(not&nbsp;(nil?&nbsp;exists-before))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 185&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 186&nbsp;&nbsp;(defn&nbsp;order-by
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 187&nbsp;&nbsp;&nbsp;&nbsp;[query&nbsp;order&nbsp;direction]
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 188&nbsp;&nbsp;&nbsp;&nbsp;(cond
                </span><br/>
<span class="partial" title="4 out of 21 forms covered">
                 189&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(=&nbsp;order&nbsp;"amount")&nbsp;(h-sql/order-by&nbsp;query&nbsp;[:currency&nbsp;(keyword&nbsp;direction)]&nbsp;[:amount&nbsp;(keyword&nbsp;direction)]&nbsp;[(keyword&nbsp;"invoices.id")])
                </span><br/>
<span class="partial" title="4 out of 16 forms covered">
                 190&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(=&nbsp;order&nbsp;"user_name")&nbsp;(h-sql/order-by&nbsp;query&nbsp;[:user-name&nbsp;(keyword&nbsp;direction)]&nbsp;[(keyword&nbsp;"invoices.id")])
                </span><br/>
<span class="covered" title="17 out of 17 forms covered">
                 191&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:else&nbsp;(h-sql/order-by&nbsp;query&nbsp;[(keyword&nbsp;(str&nbsp;"invoices."&nbsp;order))&nbsp;(keyword&nbsp;direction)]&nbsp;[(keyword&nbsp;"invoices.id")])))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 192&nbsp;&nbsp;
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 193&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 194&nbsp;&nbsp;(defn-&nbsp;generate-order-by-query
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 195&nbsp;&nbsp;&nbsp;&nbsp;[order&nbsp;direction]
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 196&nbsp;&nbsp;&nbsp;&nbsp;(cond
                </span><br/>
<span class="partial" title="4 out of 13 forms covered">
                 197&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(=&nbsp;order&nbsp;"amount")&nbsp;(str&nbsp;"currency&nbsp;"&nbsp;direction&nbsp;",&nbsp;"&nbsp;"amount&nbsp;"&nbsp;direction&nbsp;",&nbsp;"&nbsp;"i.id")
                </span><br/>
<span class="partial" title="4 out of 10 forms covered">
                 198&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(=&nbsp;order&nbsp;"user_name")&nbsp;(str&nbsp;"user_name&nbsp;"&nbsp;direction&nbsp;",&nbsp;"&nbsp;"i.id")
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 199&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:else&nbsp;(str&nbsp;"i."&nbsp;order&nbsp;"&nbsp;"&nbsp;direction&nbsp;",&nbsp;"&nbsp;"i.id")))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 200&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 201&nbsp;&nbsp;(defn-&nbsp;find-first-non-empty
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 202&nbsp;&nbsp;&nbsp;&nbsp;[params]
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 203&nbsp;&nbsp;&nbsp;&nbsp;(first&nbsp;(remove&nbsp;clojure.string/blank?&nbsp;params)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 204&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 205&nbsp;&nbsp;(defn-&nbsp;generate-next-and-prev-invoice-query
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 206&nbsp;&nbsp;&nbsp;&nbsp;[params]
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 207&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[org-id&nbsp;(:id&nbsp;(org/lookup-by-name&nbsp;(:organization-name&nbsp;params)))
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 208&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order&nbsp;(find-first-non-empty&nbsp;[(:order&nbsp;params)&nbsp;default-order])
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 209&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;direction(find-first-non-empty&nbsp;[(:direction&nbsp;params)&nbsp;default-direction])]
                </span><br/>
<span class="covered" title="21 out of 21 forms covered">
                 210&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<<&nbsp;"select&nbsp;*&nbsp;from&nbsp;(select&nbsp;i.id&nbsp;as&nbsp;id,
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 211&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LEAD&nbsp;(i.id)&nbsp;OVER&nbsp;(ORDER&nbsp;BY&nbsp;~(generate-order-by-query&nbsp;order&nbsp;direction))&nbsp;AS&nbsp;next_item_id,
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 212&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LAG&nbsp;(i.id)&nbsp;OVER&nbsp;(ORDER&nbsp;BY&nbsp;~(generate-order-by-query&nbsp;order&nbsp;direction))&nbsp;AS&nbsp;prev_item_id
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 213&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;~(name&nbsp;table-name)&nbsp;AS&nbsp;i
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 214&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left&nbsp;join&nbsp;users&nbsp;u&nbsp;on&nbsp;i.email&nbsp;=&nbsp;u.email
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 215&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;deleted&nbsp;=&nbsp;false&nbsp;and&nbsp;organization_id&nbsp;=&nbsp;'~(str&nbsp;org-id)')
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 216&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;as&nbsp;subquery&nbsp;where&nbsp;id&nbsp;=&nbsp;?")))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 217&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 218&nbsp;&nbsp;(defn&nbsp;next-and-prev-invoices
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 219&nbsp;&nbsp;&nbsp;&nbsp;[id&nbsp;params]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 220&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[uuid&nbsp;^java.util.UUID&nbsp;id]
                </span><br/>
<span class="covered" title="9 out of 9 forms covered">
                 221&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(first&nbsp;(db/query&nbsp;[(generate-next-and-prev-invoice-query&nbsp;params)&nbsp;uuid]))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 222&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 223&nbsp;&nbsp;(defn&nbsp;invoice-web-link
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 224&nbsp;&nbsp;&nbsp;&nbsp;[id&nbsp;organization-name]
                </span><br/>
<span class="not-covered" title="0 out of 9 forms covered">
                 225&nbsp;&nbsp;&nbsp;&nbsp;(str&nbsp;"https://"&nbsp;organization-name&nbsp;"."&nbsp;(cfg/web-client-name)&nbsp;"/expenses/"&nbsp;id))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 226&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 227&nbsp;&nbsp;(defn&nbsp;size
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 228&nbsp;&nbsp;&nbsp;&nbsp;[{:keys&nbsp;[organization-name]&nbsp;:as&nbsp;m}]
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 229&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[org-id&nbsp;(:id&nbsp;(org/lookup-by-name&nbsp;organization-name))]
                </span><br/>
<span class="covered" title="11 out of 11 forms covered">
                 230&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(->&nbsp;(h-sql/select&nbsp;:%count.id)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 231&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(h-sql/from&nbsp;table-name)
                </span><br/>
<span class="covered" title="12 out of 12 forms covered">
                 232&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(h-sql/where&nbsp;[:and&nbsp;[:=&nbsp;:organization_id&nbsp;org-id]&nbsp;[:=&nbsp;:deleted&nbsp;false]])
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 233&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sql/format
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 234&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db/query
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 235&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;first
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 236&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:count)))
                </span><br/>
 </body>
</html>
